'use strict';var _typeof='function'==typeof Symbol&&'symbol'==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&'function'==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?'symbol':typeof a},JSNInstaller=function(a){var b=function(){this.installer=a('#jsn-installer'),this.schedules=a('#jsn-installer-list'),this.loginForm=a('#jsn-installer-login'),this.schedules?this.loginForm.length?this.init():this.install():this.finish()};return b.prototype={init:function init(){this.loginForm.find('button.btn').click(a.proxy(this.install,this))},install:function install(){this.loginForm.length&&(this.loginForm.hide(),this.schedules.show()),this.schedules=this.schedules.children('li'),this.current=0,this.downloadPackage()},downloadPackage:function downloadPackage(){this.current<this.schedules.length?(this.schedules.eq(this.current).find('ul').show(),this.schedules.eq(this.current).find('.jsn-installer-downloading').css('display','list-item'),this.installer[0].task.value='installer.download',a.ajax({url:this.installer.attr('action')+'?'+this.schedules.eq(this.current).attr('ref'),data:this.installer.serialize(),type:this.installer.attr('method'),context:this,complete:function complete(c){var f,e=this.schedules.eq(this.current).find('.jsn-installer-downloading .jsn-installer-status').removeClass('jsn-icon-loading');this.clearTimer(this.schedules.eq(this.current).find('.jsn-installer-downloading .jsn-installer-processing')),(f=c.responseText.match(/^FAIL:([^\|]+)\|(https?:\/\/.+)$/))?(e.addClass('jsn-icon-warning'),this.schedules.eq(this.current).find('.jsn-installer-downloading .jsn-installer-error').show().html(f[1]),this.manualDownload(f[2])):c.responseText.match(/^jsn_[^\s]+_install\.zip$/)?(e.addClass('jsn-icon-ok'),this.installPackage(c.responseText)):(e.addClass('jsn-icon-fail'),this.schedules.eq(this.current).find('.jsn-installer-downloading .jsn-installer-error').show().html(c.responseText),this.current++,this.downloadPackage())}})):this.finish(),this.setTimer(this.schedules.eq(this.current).find('.jsn-installer-downloading .jsn-installer-processing'))},manualDownload:function manualDownload(c){this.downloader=this.downloader||a('#jsn-installer-manual-download'),this.downloader.show().appendTo(this.schedules.eq(this.current).find('.jsn-installer-downloading .jsn-installer-error').show()),this.downloader.find('ol li a').attr('href',c),this.downloader.find('button').unbind('click').click(a.proxy(function(){return this.installPackage(),!1},this))},installPackage:function installPackage(c){if(c||'block'!=this.downloader.css('display')||(this.schedules.eq(this.current).find('.jsn-installer-downloading .jsn-installer-status').removeClass('jsn-icon-warning').addClass('jsn-icon-ok'),this.downloader.parent().hide()),this.schedules.eq(this.current).find('.jsn-installer-installing').css('display','list-item'),this.installer[0].task.value='installer.install',c)a.ajax({url:this.installer.attr('action')+'?package='+c+'&'+this.schedules.eq(this.current).attr('ref'),data:this.installer.serialize(),type:this.installer.attr('method'),context:this,complete:this.finalizeInstall});else{var d='jsn_installer_iframe_'+this.current,e=function(){var h=document.createElement('div');return function(i){h.innerHTML=i;var j=h.firstChild;return h.removeChild(j)}}();for(var f in this.iframe=e('<iframe src="javascript:false;" name="'+d+'" />'),this.iframe.setAttribute('id',d),this.iframe.style.display='none',document.body.appendChild(this.iframe),this.form=e('<form method="post" enctype="multipart/form-data"></form>'),this.form.setAttribute('action',this.installer.attr('action')+'?'+this.schedules.eq(this.current).attr('ref')),this.form.setAttribute('target',this.iframe.name),this.form.style.display='none',document.body.appendChild(this.form),this.installer[0])if(this.installer[0][f]&&this.installer[0][f].nodeName&&'input'==this.installer[0][f].nodeName.toLowerCase())if('hidden'==this.installer[0][f].getAttribute('type')){var g=document.createElement('input');g.setAttribute('type','hidden'),g.setAttribute('name',f),g.setAttribute('value',this.installer[0][f].value),this.form.appendChild(g)}else'file'==this.installer[0][f].getAttribute('type')&&this.form.appendChild(this.installer[0][f]);this.form.submit(),this.form.parentNode.removeChild(this.form),this.form=null,a('#jsn-installer-package-selector').append(e('<input type="file" name="package" size="40" />')),this.getResponse()}this.setTimer(this.schedules.eq(this.current).find('.jsn-installer-installing .jsn-installer-processing'))},getResponse:function getResponse(){var c=!1;this.iframe.onload=function(){if('javascript:\'%3Chtml%3E%3C/html%3E\';'==this.iframe.src||'javascript:\'<html></html>\';'==this.iframe.src)return void(c&&setTimeout(a.proxy(function(){this.iframe.parentNode.removeChild(this.iframe),this.iframe=null},this),0));var d=this.iframe.contentDocument?this.iframe.contentDocument:window.frames[this.iframe.id].document;d.readyState&&'complete'!=d.readyState||d.body&&'false'==d.body.innerHTML||(this.finalizeInstall(d.body.innerHTML),c=!0,this.iframe.src='javascript:\'<html></html>\';')}.bind(this)},finalizeInstall:function finalizeInstall(c){var e,c='object'==('undefined'==typeof c?'undefined':_typeof(c))?c.responseText:c,d=this.schedules.eq(this.current).find('.jsn-installer-installing .jsn-installer-status').removeClass('jsn-icon-loading');this.clearTimer(this.schedules.eq(this.current).find('.jsn-installer-installing .jsn-installer-processing')),(e=c.match(/^FAIL:([^\|]+)\|(https?:\/\/.+)$/))?(d.addClass('jsn-icon-warning'),this.schedules.eq(this.current).find('.jsn-installer-installing .jsn-installer-error').show().html(e[1]),this.manualDownload(e[2])):('SUCCESS'==c?d.addClass('jsn-icon-ok'):(d.addClass('jsn-icon-fail'),this.schedules.eq(this.current).find('.jsn-installer-installing .jsn-installer-error').show().html(c)),this.current++,this.downloadPackage())},finish:function finish(){this.installer[0].task.value='installer.finalize',a('#jsn-installer-finalization').show()},setTimer:function setTimer(c){this.processing=c,this.timer=setInterval(a.proxy(function(){var d=this.processing.html();'Still in progress...'==d?this.processing.html('Please wait...'):this.processing.html('Still in progress...')},this),3e3)},clearTimer:function clearTimer(c){clearInterval(this.timer),c.hide()}},b}(jQuery);new JSNInstaller;